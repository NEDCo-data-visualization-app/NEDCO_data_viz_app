{% extends "base.html" %}
{% block content %}
<div class="row g-4">
  <!-- Sidebar -->
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm sticky">
      <div class="card-body">
        <h5 class="card-title mb-3">Filters</h5>

        <form method="get" action="/">
          <!-- Date range -->
          <div class="mb-3">
            <label class="form-label">Starting date ({{ date_col }})</label>
            <input type="date" class="form-control" name="start_date" value="{{ start_value }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Ending date ({{ date_col }})</label>
            <input type="date" class="form-control" name="end_date" value="{{ end_value }}">
          </div>

          <hr class="my-3"/>

          <!-- Checkbox filters -->
          <div class="accordion" id="filtersAccordion">
            {% for col, vals in unique_values.items() %}
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading-{{ loop.index }}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                          data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false"
                          aria-controls="collapse-{{ loop.index }}">
                    {{ col }}
                  </button>
                </h2>
                <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse"
                     aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#filtersAccordion">
                  <div class="accordion-body">
                    {% if vals and vals|length > 0 %}
                      {% set selected = args.getlist(col) %}

                      {% if col|lower == 'meterid' %}
                        <!-- Meter ID search + multi-select (dynamic; list populated by charts.js via /options/meterid) -->
                        <div class="mb-2">
                          <input id="meteridSearch"
                                 type="text"
                                 class="form-control filter-search-input"
                                 placeholder="Search meterid (type to load)">
                        </div>
                        <div id="meteridList" class="filter-wrap"></div>

                      {% elif col|lower == 'loc' %}
                        <!-- Location search + multi-select -->
                        <div class="mb-2">
                          <input id="locSearch"
                                 type="text"
                                 class="form-control filter-search-input"
                                 data-filter-target="#locList"
                                 placeholder="Search location">
                        </div>
                        <div id="locList" class="filter-wrap">
                          {% for v in vals %}
                            <label class="filter-item">
                              <input type="checkbox" name="{{ col }}" value="{{ v }}"
                                     {% if v in selected %}checked{% endif %}>
                              <span class="label-text">{{ v }}</span>
                            </label>
                          {% endfor %}
                        </div>

                      {% else %}
                        <!-- Default checkbox list -->
                        <div class="filter-wrap">
                          {% for v in vals %}
                            <label class="filter-item">
                              <input type="checkbox" name="{{ col }}" value="{{ v }}"
                                     {% if v in selected %}checked{% endif %}>
                              <span class="label-text">{{ v }}</span>
                            </label>
                          {% endfor %}
                        </div>
                      {% endif %}
                    {% else %}
                      <div class="text-muted">No values available.</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="d-grid gap-2 mt-3">
            <button class="btn btn-success" type="submit">Apply Filters</button>
            <a class="btn btn-secondary" href="/">Reset</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Results</h5>

        {% if chart_metrics and chart_metrics|length > 0 %}
          {% set current_metric = args.get('metric') or default_metric %}
          {% set current_freq = (args.get('freq') or 'D').upper() %}
          <div class="row g-2 align-items-end mb-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Metric</label>
              <div class="dropdown">
                <button class="form-select text-start" type="button" id="metricDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  Select metrics
                </button>
                <div class="dropdown-menu p-2" aria-labelledby="metricDropdown" style="max-height: none;">
                  {% for col, label in chart_metrics %}
                    <div class="form-check">
                      <input class="form-check-input metric-checkbox" type="checkbox" value="{{ col }}" id="metricCheck{{ loop.index }}"
                        {% if col == current_metric %}checked{% endif %}>
                      <label class="form-check-label" for="metricCheck{{ loop.index }}">{{ label }}</label>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Removed inline script: metric dropdown logic now lives in charts.js -->

            <div class="col-12 col-md-4">
              <label class="form-label">Granularity</label>
              <select id="freqSelect" class="form-select">
                <option value="D" {% if current_freq =='D' %}selected{% endif %}>Daily</option>
                <option value="W" {% if current_freq =='W' %}selected{% endif %}>Weekly</option>
                <option value="M" {% if current_freq =='M' %}selected{% endif %}>Monthly</option>
              </select>
            </div>

          </div>

          <!-- Time series -->
          <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
              <h6 class="mb-1">Time series: {{ date_col }} vs Metric</h6>
              <div class="text-muted small mb-2">Values shown are <strong>mean</strong> per selected time bucket.</div>
              <div class="chart-box"><canvas id="lineChart"></canvas></div>
              <button class="btn btn-outline-secondary btn-sm mt-2"
                      onclick="downloadChart('lineChart','time_series.png')">
                Download Chart
              </button>
            </div>
          </div>

          <!-- Composition donut -->
          <div class="row g-3" id="pieChartsRow"></div>

          <!-- Bar chart by city -->
          <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
              <h6 class="mb-1">Totals by City</h6>
              <div class="text-muted small mb-2">Shows the <strong>sum</strong> of the selected metric grouped by city.</div>
              <div class="chart-box"><canvas id="barChart"></canvas></div>
              <button class="btn btn-outline-secondary btn-sm mt-2"
                      onclick="downloadChart('barChart','totals_by_city.png')">
                Download Chart
              </button>
            </div>
          </div>
        {% else %}
          <div class="alert alert-warning mb-3">
            No numeric metrics available to chart for the current dataset.
          </div>
        {% endif %}

        {% if summary %}
          <div class="text-muted small mb-3">
            {% if summary.date_min and summary.date_max %}
              Range: {{ summary.date_min }} → {{ summary.date_max }} ·
            {% endif %}
            {% if summary.meters is not none %}
              Meters: {{ "{:,}".format(summary.meters) }} ·
            {% endif %}
            {% if summary.locations is not none %}
              Locations: {{ "{:,}".format(summary.locations) }} ·
            {% endif %}
            Rows: {{ "{:,}".format(summary.rows) }} • Cols: {{ summary.cols }}
          </div>
        {% endif %}

        {% if stats %}
          {% for key, s in stats.items() %}
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <h6 class="mb-0">{{ s.label }}</h6>
                </div>
                <div class="row g-2">
                  <div class="col-6 col-md-4 col-xl-2">
                    <div class="p-2 bg-light rounded">
                      <div class="text-muted small">Sum</div>
                      <div class="fs-5 fw-semibold text-nowrap">{{ "{:,.2f}".format(s.sum) }}</div>
                    </div>
                  </div>
                  <div class="col-6 col-md-4 col-xl-2">
                    <div class="p-2 bg-light rounded">
                      <div class="text-muted small">Mean</div>
                      <div class="fs-5 fw-semibold text-nowrap">{{ "{:,.2f}".format(s.mean) }}</div>
                    </div>
                  </div>
                  <div class="col-6 col-md-4 col-xl-2">
                    <div class="p-2 bg-light rounded">
                      <div class="text-muted small">Median</div>
                      <div class="fs-5 fw-semibold text-nowrap">{{ "{:,.2f}".format(s.median) }}</div>
                    </div>
                  </div>
                  <div class="col-6 col-md-4 col-xl-2">
                    <div class="p-2 bg-light rounded">
                      <div class="text-muted small">Min</div>
                      <div class="fs-5 fw-semibold text-nowrap">{{ "{:,.2f}".format(s.min) }}</div>
                    </div>
                  </div>
                  <div class="col-6 col-md-4 col-xl-2">
                    <div class="p-2 bg-light rounded">
                      <div class="text-muted small">Max</div>
                      <div class="fs-5 fw-semibold text-nowrap">{{ "{:,.2f}".format(s.max) }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% endif %}

        <!-- Table + NEW download button -->
        <div class="table-responsive">
          {{ preview_html|safe }}
        </div>
        <button class="btn btn-outline-secondary btn-sm mt-2"
                onclick="downloadFilteredCSV()">
          Download Table (CSV)
        </button>

      </div>
    </div>
  </div>
</div>
{% endblock %}
