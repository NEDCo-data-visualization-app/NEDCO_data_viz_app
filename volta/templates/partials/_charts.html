<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h5 class="card-title">Results</h5>

    {% if chart_metrics and chart_metrics|length > 0 %}
      {% set current_metric = args.get('metric') or default_metric %}
      {% set current_freq   = (args.get('freq') or 'D').upper() %}

      <div class="row g-2 align-items-end mb-3">
        <div class="col-12 col-md-4">
          <label class="form-label">Metric</label>
          <div class="dropdown">
            <button class="form-select text-start" type="button" id="metricDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              Select metrics
            </button>
            <div class="dropdown-menu p-2" aria-labelledby="metricDropdown">
              {% for col, label in chart_metrics %}
                <div class="form-check">
                  <input class="form-check-input metric-checkbox" type="checkbox" value="{{ col }}" id="metricCheck{{ loop.index }}"
                         {% if col == current_metric %}checked{% endif %}>
                  <label class="form-check-label" for="metricCheck{{ loop.index }}">{{ label }}</label>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Granularity</label>
          <select id="freqSelect" class="form-select">
            <option value="D" {% if current_freq == 'D' %}selected{% endif %}>Daily</option>
            <option value="W" {% if current_freq == 'W' %}selected{% endif %}>Weekly</option>
            <option value="M" {% if current_freq == 'M' %}selected{% endif %}>Monthly</option>
          </select>
        </div>
      </div>

      <!-- Time series -->
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h6 class="mb-1">Time series: {{ date_col }} vs Metric</h6>
          <div class="text-muted small mb-2">Values shown are <strong>mean</strong> per selected time bucket.</div>
          <div class="chart-box"><canvas id="lineChart"></canvas></div>
          <button class="btn btn-outline-secondary btn-sm mt-2"
                  onclick="downloadChart('lineChart','time_series.png')">
            Download Chart
          </button>
        </div>
      </div>

      <!-- Composition donut(s) -->
      <div class="row g-3" id="pieChartsRow"></div>

      <!-- Bar by city -->
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h6 class="mb-1">Totals by City</h6>
          <div class="text-muted small mb-2">Shows the <strong>sum</strong> of the selected metric grouped by city.</div>
          <div class="chart-box"><canvas id="barChart"></canvas></div>
          <button class="btn btn-outline-secondary btn-sm mt-2"
                  onclick="downloadChart('barChart','totals_by_city.png')">
            Download Chart
          </button>
        </div>
      </div>
    {% else %}
      <div class="alert alert-warning mb-0">
        No numeric metrics available to chart for the current dataset.
      </div>
    {% endif %}
  </div>
</div>
